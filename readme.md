Python API to ask ChatGPT about vulnerabilities and other fun stuff for DevOps.

## Usage

## Authentication
The authentication middleware works in two ways:
1. If the API is running locally, you can use the `.env` file to set the 'system' user API key.
   1. If the X-API-CONSUMER is 'system' then the local API key will be used.
2. If the API is running in Azure, it will use the Azure Key Vault to get the API key.
   1. If the X-API-CONSUMER is anything other than 'system' then the Azure Key Vault will be used.
   2. A lookup will be used to get the API key from the Key Vault using the X-API-CONSUMER as the identifier.


## Local Development
### Secrets setup
To run the API locally, you will need to create a `.env` file in the root of the project with the following content:
```
OPENAI_API_KEY=<your_openai_api_key>
SYSTEM_API_KEY=<your_system_api_key>
AZURE_VAULT_ID=<your_azure_key_vault_id>
```

### Local Setup
To run the API locally, you can use the following commands:

#### Requirements
To install the requirements:
```
make build-local
```

This installs:
```
-- fastapi
-- uvicorn
-- requests
-- pytest
-- openai
-- python-dotenv
-- azure-identity
-- azure-keyvault-secrets
-- starlette
```

#### Start Server
```
make run-local
```

### Docker
To run the API using Docker, you can use the following commands:

#### Build and Run
```
make build
make run
```


# Terraform Setup and Usage

This project uses Terraform to manage infrastructure. The Terraform scripts are located in the `terraform/envs/stable` directory.

## Prerequisites

- Terraform >= 0.14
- Azure CLI
- Make

### Environment Variables
The following environment variables are required to be set in your environment:
```
ARM_CLIENT_ID
ARM_CLIENT_SECRET
ARM_SUBSCRIPTION_ID
ARM_TENANT_ID
BACKEND_RESOURCE_GROUP
BACKEND_STORAGE_ACCOUNT
BACKEND_CONTAINER_NAME
OPENAI_API_KEY
SYSTEM_API_KEY
AZURE_VAULT_ID
```


## Linting

Before running any Terraform commands, it's a good practice to lint your Terraform scripts to catch any syntax or formatting issues. You can do this by running the following command:

```
make tf-lint
```

If the linting fails, you will need to fix the issues before you can proceed. You can also run the following command to automatically fix some of the issues:

```
make tf-fmt
```

## Initialization
Before you can apply any Terraform configuration, you need to initialize your Terraform working directory. You can do this by running the following command:

```
make tf-init
```

This command is also defined in the Makefile and it runs the init_terraform.sh script located in the buildscripts directory.


## Planning
The terraform plan command is used to create an execution plan. This step is necessary to see which actions Terraform will perform to reach the desired state defined in the Terraform scripts. 

You can do this by running the following command:

```
make tf-plan
```

## Applying
After planning, the next step is to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan. 

You can do this by running the following command:

```
make tf-apply
```

##Â Destroying
If you want to destroy all resources created by Terraform, you can do this by running the following command:

```
make tf-destroy
```

Please note that this command will destroy all resources managed by Terraform in your Azure subscription.

## Continuous Deployment
This project is set up to use GitHub Actions for continuous deployment. The workflow is defined in .github/workflows/deploy-terraform.yml. On every push to the main branch, the workflow lints and initializes Terraform, creates an execution plan, and applies it. Ensure that the required environment variables are set in your GitHub repository secrets.